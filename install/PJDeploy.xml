<?xml version="1.0"?>

<!--
**********************************************************************
*                                                                    *
*  This file deploys the application.                                *
*                                                                    *
**********************************************************************
-->


<!-- Define the project -->
<project 
   basedir="."
   default="DeployPackage" 
   name="Code Package">

   <!-- Define the description -->
   <description>
      Code Package Deployment
   </description>

   <!-- Define property names and values -->
   <property 
      name="version" 
      value="1.2.1"/>
   
   <property 
      name="project_name" 
      value="Code Package"/>
   
   <!--
   **********************************************************************
   *                                                                    *
   *  Define SharePoint server information                              *
   *                                                                    *
   **********************************************************************
   -->
   
   <property
      name="sharepoint_server"
      value="pjainc.pjvista.com@SSL"/>

   <property
      name="sharepoint_share"
      value="DavWWWRoot"/>

   <property
      name="sharepoint_directory"
      value="Shared Documents\Tech Support\Application Installation and Configuration"/>

   <property
      name="sharepoint_path"
      value="\\${sharepoint_server}\${sharepoint_share}\${sharepoint_directory}\${project_name}\${version}"/>
   
   <!--
   **********************************************************************
   *                                                                    *
   *  Define SoftwareImages server information                          *
   *                                                                    *
   **********************************************************************
   -->
   
   <property
      name="target_server1"
      value="192.168.68.120"/>

   <property
      name="target_share1"
      value="d$"/>

   <property
      name="target_directory1"
      value="SoftwareImages"/>
   
	<property
      name="target_path1"
      value="\\${target_server1}\${target_share1}\${target_directory1}\${project_name}\${version}"/>

   <!-- Define target -->
   <target name="init">
      
      <!-- Display a message -->
      <echo message="Project Name      : ${project_name}"/>

      <!-- Display a message -->
      <echo message="Version           : ${version}"/>

   </target>
	
   <!-- Define target -->
   <target 
      name="copy" 
      depends="init"
      description="Copy the files">
   	
      <!--
      **********************************************************************
      *                                                                    *
      *  Copy files to SharePoint                                          *
      *                                                                    *
      **********************************************************************
      -->

      <!-- Display a message -->
      <echo message="SharePoint        : ${sharepoint_path}"/>

      <!-- Create the version directory -->
      <mkdir dir="${sharepoint_path}"/>

      <!-- Copy to SharePoint -->
      <copy todir="${sharepoint_path}" verbose="true" >
         <fileset dir="..\doc"
            includes="*.pdf"/>
      </copy>

      
      <!--
      **********************************************************************
      *                                                                    *
      *  Copy files to SoftwareImages                                      *
      *                                                                    *
      **********************************************************************
      -->

      <!-- Display a message -->
      <echo message="SoftwareImages    : ${target_path1}"/>

      <!-- Create the directory -->
      <mkdir dir="\\${target_server1}\${target_share1}\${target_directory1}\${project_name}\${version}"/>
   	
      <!-- Copy the entire 'dist' directory 
           to the target directory -->
		<copy todir="${target_path1}" verbose="true" >
         <resources>
            <file file="dist/CodePackage_x64.exe" />
            <file file="history.txt" />
         </resources>
      </copy>

   </target>
   
   <!-- Define target -->
   <target 
      name="DeployPackage"
      depends="copy"
      description="Send email">

   	<!-- Run powershell ExtractReleaseHistory script to extract the latest build info from History.txt -->
      <!-- 
           ExtractReleaseHistory depends on a certain format - Build *** followed by a CRLF date CRLF and 
           a series of dashes drawn to that of a line separator
      -->
    
      <exec executable="powershell" dir=".">
         <arg line="-ExecutionPolicy bypass" />
         <arg line="-File ExtractReleaseHistory.ps1" />
         <arg line="-i history.txt -o CurrentVersionChanges.html -n 1 -p &quot;${project_name}&quot; -v &quot;${version}&quot;" />   
      </exec>

      <!-- Define the mail task -->
      <mail
         messagefile="CurrentVersionChanges.html"
         encoding="plain"
         messageMimeType="text/html"
         from="ProductBuild@pjats.com"
         replyto="ProductBuild@pjats.com"
         mailhost="10.0.7.50"
         mailport="25"
         subject="${project_name} ${version}"
         tolist="ProductRelease@pjats.com">
      </mail>
                
      <!-- Delete the temporary file that the ExtractReleaseHistory script created -->
      <delete file="CurrentVersionChanges.html"/>
   	
   </target>

</project>

